<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>eXeMpLify Score Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="score-analyzer-api" content="https://exemplify-analyzer-dc964678cf01.herokuapp.com">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="app container-fluid px-3 px-lg-4">
    <header class="row align-items-center g-3 py-3">
      <div class="col-12 col-lg-4">
        <div class="brand">eXeMpLify</div>
      </div>
      <div class="col-12 col-lg-8">
        <div class="header-controls">
          <div class="toggles">
            <label class="form-check form-switch toggle" data-bs-toggle="tooltip"
              title="Only run analysis for given grade; reduces overall processing time in lieu of providing an observed grade">
              <input class="form-check-input" type="checkbox" id="targetOnly" />
              <span class="form-check-label">Target Analysis Only</span>
            </label>
            <label class="form-check form-switch toggle" data-bs-toggle="tooltip"
              title="Expands analysis to compare against all fractional grades (1.5 to 4.5). Takes longer.">
              <input class="form-check-input" type="checkbox" id="fullGradeSearch" />
              <span class="form-check-label">Full Grade Search</span>
            </label>
            <button class="btn btn-outline-primary btn-sm key-analysis-btn" id="keyAnalysisBtn" data-bs-toggle="tooltip"
              title="Choose how key spellings are interpreted.">
              Key Analysis: Standard
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="row g-3 g-lg-4">
      <aside class="results col-12 col-lg-3">
        <div class="bars">
          <div class="bar-row">
            <div class="bar-head">
              <span>Range</span>
              <span class="bar-score" data-bar-score="range">--</span>
              <button class="details-mini" data-bs-toggle="tooltip"
                title="Displays range information on the details panel. Highlights potential issues for given grade.">
                <img src="icons/range.svg" alt="Range">
              </button>
            </div>
            <div class="bar">
              <img class="bar-image" src="confidence_bar.png" alt="">
              <img class="marker" src="tickmark.svg" alt="">
              <div class="bar-ticks">
                <span></span><span></span><span></span><span></span><span></span>
                <span></span><span></span><span></span><span></span><span></span>
              </div>
            </div>
          </div>

          <div class="bar-row">
            <div class="bar-head">
              <span>Key</span>
              <span class="bar-score" data-bar-score="key">--</span>
              <button class="details-mini" data-bs-toggle="tooltip"
                title="Displays key information on the details panel. Highlights potential issues for given grade.">
                <img src="icons/key.svg" alt="Key">
              </button>
            </div>
            <div class="bar">
              <img class="bar-image" src="confidence_bar.png" alt="">
              <img class="marker" src="tickmark.svg" alt="">
              <div class="bar-ticks">
                <span></span><span></span><span></span><span></span><span></span>
                <span></span><span></span><span></span><span></span><span></span>
              </div>
            </div>
          </div>

          <div class="bar-row">
            <div class="bar-head">
              <span>Articulation</span>
              <span class="bar-score" data-bar-score="articulation">--</span>
              <button class="details-mini" data-bs-toggle="tooltip"
                title="Displays articulation information on the details panel. Highlights potential issues for given grade.">
                <img src="icons/articulation.svg" alt="Articulation">
              </button>
            </div>
            <div class="bar">
              <img class="bar-image" src="confidence_bar.png" alt="">
              <img class="marker" src="tickmark.svg" alt="">
              <div class="bar-ticks">
                <span></span><span></span><span></span><span></span><span></span>
                <span></span><span></span><span></span><span></span><span></span>
              </div>
            </div>
          </div>

          <div class="bar-row">
            <div class="bar-head">
              <span>Rhythm</span>
              <span class="bar-score" data-bar-score="rhythm">--</span>
              <button class="details-mini" data-bs-toggle="tooltip"
                title="Displays rhythm information on the details panel. Highlights potential issues for given grade.">
                <img src="icons/rhythm.svg" alt="Rhythm">
              </button>
            </div>
            <div class="bar">
              <img class="bar-image" src="confidence_bar.png" alt="">
              <img class="marker" src="tickmark.svg" alt="">
              <div class="bar-ticks">
                <span></span><span></span><span></span><span></span><span></span>
                <span></span><span></span><span></span><span></span><span></span>
              </div>
            </div>
          </div>

          <div class="bar-row">
            <div class="bar-head">
              <span>Dynamics</span>
              <span class="bar-score" data-bar-score="dynamics">--</span>
              <button class="details-mini" data-bs-toggle="tooltip"
                title="Displays dynamics information on the details panel. Highlights potential issues for given grade.">
                <img src="icons/dynamic.svg" alt="Dynamics">
              </button>
            </div>
            <div class="bar">
              <img class="bar-image" src="confidence_bar.png" alt="">
              <img class="marker" src="tickmark.svg" alt="">
              <div class="bar-ticks">
                <span></span><span></span><span></span><span></span><span></span>
                <span></span><span></span><span></span><span></span><span></span>
              </div>
            </div>
          </div>

          <div class="bar-row">
            <div class="bar-head">
              <span>Availability</span>
              <span class="bar-score" data-bar-score="availability">--</span>
              <button class="details-mini" data-bs-toggle="tooltip"
                title="Displays availability information on the details panel. Highlights potential issues for given grade.">
                <img src="icons/instrument.svg" alt="Availability">
              </button>
            </div>
            <div class="bar">
              <img class="bar-image" src="confidence_bar.png" alt="">
              <img class="marker" src="tickmark.svg" alt="">
              <div class="bar-ticks">
                <span></span><span></span><span></span><span></span><span></span>
                <span></span><span></span><span></span><span></span><span></span>
              </div>
            </div>
          </div>

          <div class="bar-row">
            <div class="bar-head">
              <span>Scoring</span>
              <span class="bar-score" data-bar-score="scoring">--</span>
              <button class="details-mini" data-bs-toggle="tooltip"
                title="Displays scoring and texture information on the details panel. Highlights potential issues for given grade.">
                <img src="icons/scoring.svg" alt="Scoring">
              </button>
            </div>
            <div class="bar">
              <img class="bar-image" src="confidence_bar.png" alt="">
              <img class="marker" src="tickmark.svg" alt="">
              <div class="bar-ticks">
                <span></span><span></span><span></span><span></span><span></span>
                <span></span><span></span><span></span><span></span><span></span>
              </div>
            </div>
          </div>

          <div class="bar-row">
            <div class="bar-head">
              <span>Tempo</span>
              <span class="bar-score" data-bar-score="tempo">--</span>
              <button class="details-mini" data-bs-toggle="tooltip"
                title="Displays tempo information on the details panel. Highlights potential issues for given grade.">
                <img src="icons/tempo.svg" alt="Tempo">
              </button>
            </div>
            <div class="bar">
              <img class="bar-image" src="confidence_bar.png" alt="">
              <img class="marker" src="tickmark.svg" alt="">
              <div class="bar-ticks">
                <span></span><span></span><span></span><span></span><span></span>
                <span></span><span></span><span></span><span></span><span></span>
              </div>
            </div>
          </div>

          <div class="bar-row">
            <div class="bar-head">
              <span>Duration</span>
              <span class="bar-score" data-bar-score="duration">--</span>
              <button class="details-mini" data-bs-toggle="tooltip"
                title="Displays duration information on the details panel. Highlights potential issues for given grade.">
                <img src="icons/duration.svg" alt="Duration">
              </button>
            </div>
            <div class="bar">
              <img class="bar-image" src="confidence_bar.png" alt="">
              <img class="marker" src="tickmark.svg" alt="">
              <div class="bar-ticks">
                <span></span><span></span><span></span><span></span><span></span>
                <span></span><span></span><span></span><span></span><span></span>
              </div>
            </div>
          </div>

          <div class="bar-row">
            <div class="bar-head">
              <span>Meter</span>
              <span class="bar-score" data-bar-score="meter">--</span>
              <button class="details-mini" data-bs-toggle="tooltip"
                title="Displays meter information on the details panel. Highlights potential issues for given grade.">
                <img src="icons/meter.svg" alt="Meter">
              </button>
            </div>
            <div class="bar">
              <img class="bar-image" src="confidence_bar.png" alt="">
              <img class="marker" src="tickmark.svg" alt="">
              <div class="bar-ticks">
                <span></span><span></span><span></span><span></span><span></span>
                <span></span><span></span><span></span><span></span><span></span>
              </div>
            </div>
          </div>


          <div class="timeline-header results-timeline-header">
            <div class="timeline-controls">
              <label class="timeline-toggle">
                <input type="checkbox" id="toggleIssueMeasures" checked />
                <span>Show Measures with Issues</span>
              </label>
              <label class="timeline-toggle">
                <input type="checkbox" id="toggleKey" checked />
                <span>Key</span>
              </label>
              <label class="timeline-toggle">
                <input type="checkbox" id="toggleTempo" checked />
                <span>Tempo</span>
              </label>
              <label class="timeline-toggle">
                <input type="checkbox" id="toggleMeter" checked />
                <span>Meter</span>
              </label>
              <label class="timeline-toggle">
                <input type="checkbox" id="toggleDuration" unchecked />
                <span>Duration</span>
              </label>
            </div>
          </div>
        </div>
      </aside>


      <section class="viewer-wrap col-12 col-lg-5">
        <div class="score-controls">
          <div class="controls-block">
            <div class="controls">
              <input id="fileInput" type="file" accept=".musicxml,.xml,.mei" class="visually-hidden">
              <label for="fileInput" class="btn btn-outline-primary btn-lg w-100 score-action score-load"
                data-bs-toggle="tooltip" title="Load a score file for analysis.">Load XML Score</label>
              <button class="btn btn-outline-primary btn-lg w-100" id="analyzeBtn" data-bs-toggle="tooltip"
                title="Run analysis on the loaded score.">Analyze Score</button>
              <div class="grade-row score-grade-row">
                <span class="grade-label" data-bs-toggle="tooltip" title="Target grade of composition to analyze">Select
                  grade:</span>
                <select id="targetGradeSelect" class="form-select form-select-sm">
                  <option value="0.5">.5</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5+</option>
                </select>
              </div>
              <button class="btn btn-outline-primary btn-lg w-100 score-action score-clear" id="clearBtn"
                data-bs-toggle="tooltip" title="Clear selected score.">Clear Score</button>
            </div>
            <div class="score-title" id="scoreTitle">Score Title: --</div>
          </div>
        </div>
        <div id="app" class="verovio-app" style="border: 1px solid lightgray; min-height: 800px;"></div>
      </section>

      <aside class="details-pane col-12 col-lg-4">
        <div class="details-header">
          <h2>Analysis Details</h2>
          <button type="button" class="btn btn-outline-primary export-btn" id="exportBtn">
            Save Report
          </button>
        </div>
        <div class="observed-grade-pane" id="observedGradePane">
          <div class="observed-grade-title">
            Overall Observed Grade:
            <span class="observed-grade-value" id="observedGradeValue">--</span>
          </div>
        </div>
        <div class="detail-body"></div>
      </aside>
    </main>

    <footer class="row g-5 pb-4 pt-2">
      <div class="col-12">
        <div class="timeline">
          <div class="timeline-track" id="timelineTrack">
            <div class="timeline-line"></div>
          </div>
          <div class="timeline-range">
            <span>
              <span id="startingMeasureLabel">1</span>
            </span>

            <span style="text-align:right;">
              <span id="endingMeasureLabel">--</span>
            </span>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <!-- Sanitize BEFORE Verovio loads -->
  <script>
    (function () {
      const u = new URL(location.href);
      u.searchParams.delete("view");
      u.hash = "";
      history.replaceState({}, "", u.toString());

      try {
        // be aggressive while debugging
        localStorage.clear();
        sessionStorage.clear();
      } catch (e) { }
    })();
  </script>

  <div class="modal fade" id="progressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title mb-0">Running Analysis</h5>
          <div class="progress-timer" id="progressTimer">00m00s</div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="progressBars" class="progress-bars"></div>
          <div id="progressText" class="mt-3 text-muted small">Waiting...</div>
        </div>
        <div class="modal-footer">
          <button type="button" id="progressOkBtn" class="btn btn-primary" data-bs-dismiss="modal" disabled>OK</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="keyAnalysisModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content key-analysis-modal">
        <div class="modal-header">
          <h5 class="modal-title mb-0">Key Analysis Mode</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="key-analysis-lead" id="keyAnalysisDetectedLabel">String instruments detected</div>
          <div class="key-analysis-desc" id="keyAnalysisDetectedDesc">
            This score includes one or more string parts (e.g., violin/viola/cello/bass).
            String players typically prefer sharp-based keys over equivalent flat keys, so your key analysis can be
            interpreted in two ways:
          </div>
          <div class="key-analysis-list" id="keyAnalysisDetectedList"></div>
          <div class="key-analysis-options">
            <button type="button" class="btn btn-primary" id="keyAnalysisStringBtn">
              String Key Analysis (standard for orchestral repertoire)
            </button>
            <button type="button" class="btn btn-outline-primary" id="keyAnalysisStandardBtn">
              Standard Key Analysis (standard for wind band repertoire)
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title mb-0">Save Analysis</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="export-desc">
            Choose what to save. We'll prepare the file, then prompt you to download it.
          </p>
          <div class="export-actions">
            <button type="button" class="btn btn-primary" id="exportVisibleBtn">
              Save Visible Details (CSV)
            </button>
            <button type="button" class="btn btn-outline-primary" id="exportAllBtn">
              Save Full Analysis (JSON)
            </button>
          </div>
          <div class="export-progress" id="exportProgress" hidden>
            <div class="export-status" id="exportStatus">Preparing file...</div>
            <div class="progress">
              <div class="progress-bar" id="exportProgressBar" style="width: 0%;">0%</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="config.js"></script>
  <script type="module" src="./script.js"></script>
</body>

</html>
